<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Replit-Style Python 3D Editor</title>
    
    <!-- Babylon.js CDN -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    
    <!-- Pyodide CDN -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    
    <!-- Monaco Editor CDN for syntax highlighting -->
    <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        /* Header Bar */
        .header {
            background: #2d2d30;
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #3e3e42;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #cccccc;
        }

        /* Main Layout */
        .container {
            display: flex;
            height: calc(100vh - 50px);
        }

        /* Left Panel - Python Editor */
        .left-panel {
            width: 40%;
            background: #1e1e1e;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }

        .editor-header {
            background: #2d2d30;
            padding: 10px 15px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-title {
            font-size: 14px;
            font-weight: 500;
            color: #cccccc;
        }

        .run-button {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .run-button:hover {
            background: #005a9e;
        }

        .run-button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        /* Monaco Editor Container */
        .editor-container {
            flex: 1;
            position: relative;
        }

        /* Output Panel */
        .output-panel {
            height: 120px;
            background: #252526;
            border-top: 1px solid #3e3e42;
            padding: 10px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        .output-panel .output-line {
            margin-bottom: 2px;
        }

        .output-panel .error {
            color: #f14c4c;
        }

        .output-panel .success {
            color: #4ec9b0;
        }

        /* Right Panel - 3D Canvas */
        .right-panel {
            width: 60%;
            background: #1e1e1e;
            display: flex;
            flex-direction: column;
        }

        .canvas-header {
            background: #2d2d30;
            padding: 10px 15px;
            border-bottom: 1px solid #3e3e42;
        }

        .canvas-title {
            font-size: 14px;
            font-weight: 500;
            color: #cccccc;
        }

        .canvas-container {
            flex: 1;
            position: relative;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            display: block;
            outline: none;
        }

        /* Loading Indicator */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #cccccc;
            font-size: 14px;
        }

        /* Status Bar */
        .status-bar {
            background: #007acc;
            color: white;
            padding: 5px 15px;
            font-size: 12px;
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                width: 100%;
            }
            
            .left-panel {
                height: 50%;
            }
            
            .right-panel {
                height: 50%;
            }
        }
    </style>
</head>
<body>
    <!-- Header Bar -->
    <div class="header">
        <h1>üêç Python 3D Editor - Replit Style</h1>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Panel - Python Editor -->
        <div class="left-panel">
            <div class="editor-header">
                <span class="editor-title">üìù main.py</span>
                <button id="runBtn" class="run-button">‚ñ∂ Run Script</button>
            </div>
            
            <!-- Monaco Editor Container -->
            <div class="editor-container" id="editor-container"></div>
            
            <!-- Output Panel -->
            <div class="output-panel" id="output">
                <div class="output-line">üöÄ Ready to execute Python scripts...</div>
                <div class="output-line">üí° Try running the default script to spawn a red box!</div>
            </div>
        </div>

        <!-- Right Panel - 3D Canvas -->
        <div class="right-panel">
            <div class="canvas-header">
                <span class="canvas-title">üéÆ 3D Scene Preview</span>
            </div>
            
            <div class="canvas-container">
                <canvas id="renderCanvas"></canvas>
                <div id="loading" class="loading">Initializing 3D engine...</div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar" id="status">
        Initializing Pyodide and Babylon.js...
    </div>

    <script>
        // Global variables
        let pyodide;
        let engine;
        let scene;
        let camera;
        let editor;
        let isInitialized = false;
        window.blueprintShapes = {};
        window.blueprintNPCs = {};

        // Default Python script
        const defaultPythonScript = `# Welcome to the Creative Game Engine!
# Define a new trapezoid shape and spawn it
define_shape("trapezoid", {
  "vertices": [[0,0], [2,0], [1.5,1], [0.5,1]],
  "color": "orange"
})
spawn_custom("trapezoid", x=0, y=0, z=0)

# Define an NPC with a custom model
define_npc("dino_guard", {
  "mesh": "dino.glb",
  "scale": [2,2,2],
  "message": "Aku penjaga dari masa lalu!"
})
spawn_npc("dino_guard", x=3, y=0, z=0)`;

        // Initialize Monaco Editor
        function initializeEditor() {
            require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.44.0/min/vs' } });
            
            require(['vs/editor/editor.main'], function () {
                editor = monaco.editor.create(document.getElementById('editor-container'), {
                    value: defaultPythonScript,
                    language: 'python',
                    theme: 'vs-dark',
                    fontSize: 14,
                    minimap: { enabled: false },
                    scrollBeyondLastLine: false,
                    automaticLayout: true,
                    lineNumbers: 'on',
                    roundedSelection: false,
                    scrollbar: {
                        vertical: 'visible',
                        horizontal: 'visible'
                    }
                });
                
                updateStatus("Monaco Editor initialized ‚úì");
            });
        }

        // Initialize Babylon.js 3D Engine
        function initializeBabylonJS() {
            const canvas = document.getElementById('renderCanvas');
            engine = new BABYLON.Engine(canvas, true);

            // Create scene
            scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color3(0.1, 0.1, 0.2);

            // Create camera
            camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, Math.PI / 2.5, 10, BABYLON.Vector3.Zero(), scene);
            camera.attachControls(canvas, true);

            // Create lighting
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.7;

            // Create ground
            const ground = BABYLON.MeshBuilder.CreateGround("ground", { width: 10, height: 10 }, scene);
            const groundMaterial = new BABYLON.StandardMaterial("groundMat", scene);
            groundMaterial.diffuseColor = new BABYLON.Color3(0.3, 0.3, 0.3);
            ground.material = groundMaterial;

            // Start render loop
            engine.runRenderLoop(() => {
                scene.render();
            });

            // Handle window resize
            window.addEventListener("resize", () => {
                engine.resize();
            });

            document.getElementById('loading').style.display = 'none';
            updateStatus("Babylon.js 3D engine initialized ‚úì");
        }

        // Initialize Pyodide
        async function initializePyodide() {
            try {
                updateStatus("Loading Pyodide Python runtime...");
                pyodide = await loadPyodide();
                
                // Define Python bridge functions
                pyodide.globals.set("spawn_box", spawn_box);
                pyodide.globals.set("spawn_sphere", spawn_sphere);
                pyodide.globals.set("set_background", set_background);
                pyodide.globals.set("clear_scene", clear_scene);
                pyodide.globals.set("move_object", move_object);
                pyodide.globals.set("define_shape", define_shape);
                pyodide.globals.set("spawn_custom", spawn_custom);
                pyodide.globals.set("define_npc", define_npc);
                pyodide.globals.set("spawn_npc", spawn_npc);
                pyodide.globals.set("export_blueprints", export_blueprints);
                
                updateStatus("Pyodide Python runtime initialized ‚úì");
                isInitialized = true;
                
                // Enable run button
                document.getElementById('runBtn').disabled = false;
                updateStatus("üéØ Ready! Click 'Run Script' to execute Python code");
                
            } catch (error) {
                addOutput(`‚ùå Error initializing Pyodide: ${error.message}`, 'error');
                updateStatus("‚ùå Initialization failed");
            }
        }

        // Bridge Functions: Python ‚Üí JavaScript ‚Üí Babylon.js

        // Spawn a box in the 3D scene
        function spawn_box(x, y, z, color = 'red') {
            const box = BABYLON.MeshBuilder.CreateBox(`box_${Date.now()}`, { size: 1 }, scene);
            box.position = new BABYLON.Vector3(x, y, z);

            const material = new BABYLON.StandardMaterial(`boxMat_${Date.now()}`, scene);
            material.diffuseColor = parseColor(color);
            box.material = material;
            
            addOutput(`üì¶ Box spawned at (${x}, ${y}, ${z}) with color ${color}`, 'success');
        }

        // Spawn a sphere in the 3D scene
        function spawn_sphere(x, y, z, color = 'blue') {
            const sphere = BABYLON.MeshBuilder.CreateSphere(`sphere_${Date.now()}`, { diameter: 1 }, scene);
            sphere.position = new BABYLON.Vector3(x, y, z);

            const material = new BABYLON.StandardMaterial(`sphereMat_${Date.now()}`, scene);
            material.diffuseColor = parseColor(color);
            sphere.material = material;
            
            addOutput(`üîµ Sphere spawned at (${x}, ${y}, ${z}) with color ${color}`, 'success');
        }

        // Set background color
        function set_background(color) {
            scene.clearColor = parseColor(color);
            addOutput(`üé® Background color changed to ${color}`, 'success');
        }

        // Clear all objects from scene (except ground)
        function clear_scene() {
            scene.meshes.forEach(mesh => {
                if (mesh.name !== 'ground') {
                    mesh.dispose();
                }
            });
            addOutput(`üßπ Scene cleared`, 'success');
        }

        // Move an object (advanced function)
        function move_object(name, x, y, z) {
            const mesh = scene.getMeshByName(name);
            if (mesh) {
                mesh.position = new BABYLON.Vector3(x, y, z);
                addOutput(`üèÉ Object '${name}' moved to (${x}, ${y}, ${z})`, 'success');
            } else {
                addOutput(`‚ùå Object '${name}' not found`, 'error');
            }
        }

        // Define a new custom shape blueprint
        function define_shape(name, config) {
            window.blueprintShapes[name] = {
                vertices: config.vertices || [],
                color: config.color || 'white'
            };
            addOutput(`üîß Shape '${name}' defined`, 'success');
        }

        // Spawn a custom shape from blueprint
        function spawn_custom(name, x, y, z) {
            const blueprint = window.blueprintShapes[name];
            if (!blueprint) {
                console.error("Shape not defined:", name);
                addOutput(`‚ùå Shape '${name}' not found`, 'error');
                return;
            }

            const shapeVec = blueprint.vertices.map(v => new BABYLON.Vector3(v[0], v[1], 0));
            const mesh = BABYLON.MeshBuilder.CreatePolygon(`${name}_${Date.now()}`, {
                shape: shapeVec,
                sideOrientation: BABYLON.Mesh.DOUBLESIDE
            }, scene);

            mesh.position = new BABYLON.Vector3(x, y, z);
            const mat = new BABYLON.StandardMaterial(`${name}_mat_${Date.now()}`, scene);
            mat.diffuseColor = parseColor(blueprint.color);
            mesh.material = mat;

            addOutput(`üî∫ Custom '${name}' spawned at (${x}, ${y}, ${z})`, 'success');
        }

        // Define an NPC blueprint
        function define_npc(name, config) {
            window.blueprintNPCs[name] = {
                mesh: config.mesh || null,
                scale: config.scale || [1, 1, 1],
                message: config.message || ''
            };
            addOutput(`ü§ñ NPC '${name}' defined`, 'success');
        }

        // Spawn NPC from blueprint
        function spawn_npc(name, x, y, z) {
            const npc = window.blueprintNPCs[name];
            if (!npc) {
                addOutput(`‚ùå NPC '${name}' not found`, 'error');
                return;
            }
            const pos = new BABYLON.Vector3(x, y, z);
            if (npc.mesh) {
                BABYLON.SceneLoader.ImportMesh('', '', npc.mesh, scene, (meshes) => {
                    const root = meshes[0];
                    root.position = pos;
                    root.scaling = new BABYLON.Vector3(...npc.scale);
                    addOutput(`üí¨ NPC '${name}' says: ${npc.message}`, 'success');
                });
            } else {
                const box = BABYLON.MeshBuilder.CreateBox(`${name}_${Date.now()}`, { size: 1 }, scene);
                box.position = pos;
                box.scaling = new BABYLON.Vector3(...npc.scale);
                addOutput(`üí¨ NPC '${name}' says: ${npc.message}`, 'success');
            }
        }

        // Export blueprints as JSON
        function export_blueprints() {
            return JSON.stringify({ shapes: window.blueprintShapes, npcs: window.blueprintNPCs });
        }

        // Helper function to convert color names to Babylon.js colors
        function getColor(colorName) {
            const colors = {
                'red': new BABYLON.Color3(1, 0, 0),
                'green': new BABYLON.Color3(0, 1, 0),
                'blue': new BABYLON.Color3(0, 0, 1),
                'yellow': new BABYLON.Color3(1, 1, 0),
                'purple': new BABYLON.Color3(1, 0, 1),
                'cyan': new BABYLON.Color3(0, 1, 1),
                'white': new BABYLON.Color3(1, 1, 1),
                'black': new BABYLON.Color3(0, 0, 0),
                'orange': new BABYLON.Color3(1, 0.5, 0),
                'pink': new BABYLON.Color3(1, 0.7, 0.8),
                'darkblue': new BABYLON.Color3(0, 0, 0.5),
                'darkgreen': new BABYLON.Color3(0, 0.5, 0),
                'gray': new BABYLON.Color3(0.5, 0.5, 0.5),
                'brown': new BABYLON.Color3(0.6, 0.3, 0.1)
            };

            return colors[colorName.toLowerCase()] || colors['red'];
        }

        // Parse color that could be a hex string or a name
        function parseColor(value) {
            if (typeof value === 'string' && value.trim().startsWith('#')) {
                try {
                    return BABYLON.Color3.FromHexString(value);
                } catch (_) {
                    return getColor('red');
                }
            }
            return getColor(String(value || 'red'));
        }

        // Execute Python script
        async function runPythonScript() {
            if (!isInitialized) {
                addOutput("‚ùå System not initialized yet. Please wait...", 'error');
                return;
            }

            const code = editor.getValue();
            const runBtn = document.getElementById('runBtn');
            
            try {
                // Disable button during execution
                runBtn.disabled = true;
                runBtn.textContent = "‚è≥ Running...";
                
                addOutput("üèÉ Executing Python script...", 'success');
                
                // Capture Python print output
                pyodide.runPython(`
import sys
from io import StringIO
import contextlib

output_capture = StringIO()
                `);
                
                // Execute user code with output capture
                pyodide.runPython(`
with contextlib.redirect_stdout(output_capture):
    ${code}
                `);
                
                // Get captured output
                const pythonOutput = pyodide.runPython("output_capture.getvalue()");
                
                if (pythonOutput) {
                    // Display Python print statements
                    pythonOutput.split('\n').forEach(line => {
                        if (line.trim()) {
                            addOutput(`üêç ${line}`, 'success');
                        }
                    });
                }
                
                addOutput("‚úÖ Script executed successfully!", 'success');
                
            } catch (error) {
                addOutput(`‚ùå Python Error: ${error.message}`, 'error');
                console.error("Python execution error:", error);
            } finally {
                // Re-enable button
                runBtn.disabled = false;
                runBtn.textContent = "‚ñ∂ Run Script";
            }
        }

        // Utility Functions

        // Add output to the output panel
        function addOutput(message, type = 'normal') {
            const outputPanel = document.getElementById('output');
            const line = document.createElement('div');
            line.className = `output-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            outputPanel.appendChild(line);
            outputPanel.scrollTop = outputPanel.scrollHeight;
        }

        // Update status bar
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Event Listeners
        document.getElementById('runBtn').addEventListener('click', runPythonScript);

        // Keyboard shortcut: Ctrl+Enter to run script
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                runPythonScript();
            }
        });

        // Initialize everything when page loads
        window.addEventListener('load', async () => {
            try {
                // Initialize components in sequence
                initializeEditor();
                initializeBabylonJS();
                await initializePyodide();
                
                addOutput("üéâ All systems initialized! Ready to code in Python!", 'success');
                addOutput("üí° Pro tip: Use Ctrl+Enter to quickly run your script", 'success');
                
            } catch (error) {
                addOutput(`‚ùå Initialization error: ${error.message}`, 'error');
                updateStatus("‚ùå Initialization failed");
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (engine) {
                engine.dispose();
            }
        });
    </script>
</body>
</html>